name: Detect Merge/Rebase from Base Branch and Notify Teams

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-conflict-merge-message:
    runs-on: ubuntu-latest
    outputs:
      includes_base: ${{ steps.detect.outputs.includes_base }}
      merge_list: ${{ steps.detect.outputs.merge_list }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch info
        id: vars
        run: |
          echo "BASE_BRANCH=${{ github.base_ref }}" >> $GITHUB_ENV
          echo "FEATURE_BRANCH=${{ github.head_ref }}" >> $GITHUB_ENV
          BASE_COMMIT=$(git merge-base origin/main origin/${{ github.head_ref }})
          echo "BASE_COMMIT=$BASE_COMMIT" >> $GITHUB_ENV
          
      - name: Detect merge commits from devint
        run: |
          echo "üîç Checking for merge commits from devint into $FEATURE_BRANCH since $BASE_COMMIT"
          git log $BASE_COMMIT..origin/$FEATURE_BRANCH --merges --oneline --grep="devint" || echo "‚úÖ No merge commits from devint found."

      - name: List commit subjects in devint and feature branch
        run: |
          git log origin/main..origin/devint --pretty=format:"%s" > devint_commits.txt
          git log $BASE_COMMIT..origin/$FEATURE_BRANCH --pretty=format:"%s" > feature_commits.txt
          echo "üîç Checking if any commits from devint are present in feature branch via rebase/cherry-pick:"
          grep -Ff devint_commits.txt feature_commits.txt || echo "‚úÖ No rebased commits from devint found."
          
      - name: Post PR comment on detection
        if: steps.detect.outputs.includes_base == 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Posting PR comment..."
          gh api -X POST /repos/$REPO/issues/$PR_NUMBER/comments \
            -f body="‚ö†Ô∏è **Critical Alert**: Merge/Rebase from \`${{ github.base_ref }}\` detected in this feature branch. Please review."


