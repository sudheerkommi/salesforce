name: Detect Merge/Rebase from Base Branch and Notify Teams

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-conflict-merge-message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch info
        id: vars
        run: |
          echo "BASE_BRANCH=${{ github.base_ref }}" >> $GITHUB_ENV
          echo "FEATURE_BRANCH=${{ github.head_ref }}" >> $GITHUB_ENV
          BASE_COMMIT=$(git merge-base origin/main origin/${{ github.head_ref }})
          echo "BASE_COMMIT=$BASE_COMMIT" >> $GITHUB_ENV

      - name: Detect merges and rebases from base branch
        id: detect
        run: |
          set -e
      
          echo "üîç Checking for merge commits from $BASE_BRANCH into $FEATURE_BRANCH since $BASE_COMMIT"
      
          MERGE_LIST=$(git log $BASE_COMMIT..origin/$FEATURE_BRANCH --merges --grep="$BASE_BRANCH" --pretty=format:"%h | %an | %ad | %s" || true)
      
          git log origin/main..origin/$BASE_BRANCH --pretty=format:"%s" > devint_commits.txt
          git log $BASE_COMMIT..origin/$FEATURE_BRANCH --pretty=format:"%s" > feature_commits.txt
      
          REBASED_LIST=$(grep -Ff devint_commits.txt feature_commits.txt || true)
      
          if [[ -n "$MERGE_LIST" ]]; then
            echo "‚ùå Merge commit(s) from $BASE_BRANCH detected:"
            echo "$MERGE_LIST"
            echo "merge_list<<EOF" >> $GITHUB_OUTPUT
            echo "$MERGE_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi
      
          echo "‚úÖ No merge commits found from $BASE_BRANCH."
          echo "includes_base=false" >> $GITHUB_OUTPUT

      - name: Post PR comment if needed
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "üí¨ Posting comment to PR about invalid merge..."
          gh api -X POST /repos/$REPO/issues/$PR_NUMBER/comments \
            -f body="‚ùå **Error**: Merge commits from \`${{ github.base_ref }}\` were detected in this PR. Please remove them and rebase your branch from \`main\` instead."
