name: Detect "Commit merge" Conflict Resolution from Main

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-merge-msg:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install gh

      - name: Check PR commit messages for 'Commit merge'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=${{ github.event.pull_request.number }}
          echo "🔍 Checking commits for PR #$pr_number"

          gh pr view "$pr_number" --json commits --jq '.commits[].commit.message' > messages.txt

          expected="Merge branch '${{ github.base_ref }}' into ${{ github.head_ref }}"

          if grep -Fx "$expected" messages.txt; then
            echo "❌ Detected GitHub conflict-resolution merge: $expected"
            exit 1
          else
            echo "✅ No merge-style commit from main found."
          fi

