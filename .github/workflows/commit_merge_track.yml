name: Detect "Commit merge" Conflict Resolution from Main

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-conflict-merge-message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to get full commit history

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Detect conflict-resolution merge commit from base branch
        run: |
          echo "üîç Checking for conflict-resolution merge commits..."
          
          expected="Merge branch '${{ github.base_ref }}' into ${{ github.head_ref }}"
          echo "üîé Expected merge message (if conflict was resolved with GitHub UI):"
          echo "$expected"

          merge_msgs=$(git log origin/${{ github.base_ref }}..HEAD --merges --pretty=format:"%s")

          if echo "$merge_msgs" | grep -Fx "$expected"; then
            echo "‚ö†Ô∏è Detected GitHub 'Commit merge' conflict resolution commit:"
            echo "$expected"
            echo "‚ùó Please resolve conflicts locally using 'git rebase origin/${{ github.base_ref }}'"
            exit 1
          fi

          echo "‚úÖ No conflict-resolution merge commits found. All good."
