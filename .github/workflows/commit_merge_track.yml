name: Prevent Direct Merge Commit from Main

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-direct-main-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Detect merge commit message like "Merge branch '${{ github.base_ref }}' into ${{ github.head_ref }}"
        run: |
          echo "🔍 Checking for specific merge message from '${{ github.base_ref }}' into '${{ github.head_ref }}'..."

          pattern="Merge branch '${{ github.base_ref }}' into ${{ github.head_ref }}"

          # Get all merge commits introduced in this PR range
          merge_msgs=$(git log origin/${{ github.base_ref }}..HEAD --merges --pretty=format:"%s")

          echo "🔍 Found merge messages:"
          echo "$merge_msgs"

          # Look for specific merge message
          if echo "$merge_msgs" | grep -q "$pattern"; then
            echo "❌ Merge commit matching '$pattern' detected."
            echo "⚠️ Please use 'git rebase origin/${{ github.base_ref }}' instead of merging '${{ github.base_ref }}' into '${{ github.head_ref }}'."
            exit 1
          fi

          echo "✅ No direct 'Merge branch' commit from '${{ github.base_ref }}' found."
