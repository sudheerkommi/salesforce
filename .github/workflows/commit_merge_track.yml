name: Detect Merge/Rebase from Base Branch and Notify Teams

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-conflict-merge-message:
    runs-on: ubuntu-latest
    outputs:
      includes_base: ${{ steps.detect.outputs.includes_base }}
      merge_list: ${{ steps.detect.outputs.merge_list }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches and refs
        run: |
          git fetch --all
          git fetch origin ${{ github.base_ref }} main

      - name: Setup local main branch ref
        run: |
          # Force update local main branch to track origin/main
          git branch --force main origin/main || git checkout -b main origin/main

      - name: Show Git debug info
        run: |
          git status
          git branch -vv
          git rev-parse --verify main
          git rev-parse --verify HEAD

      - name: Detect merges/rebases from base branch
        id: detect
        run: |
          set -e
          BASE_BRANCH="${{ github.base_ref }}"
          FEATURE_BRANCH="${{ github.head_ref }}"
          MAIN_BRANCH="main"

          echo "üîç Detecting merges/rebases from $BASE_BRANCH into $FEATURE_BRANCH after diverging from $MAIN_BRANCH..."

          merge_commits=$(git log $MAIN_BRANCH..HEAD --merges --pretty=format:"%H" --grep="Merge branch '$BASE_BRANCH'" || true)

          if [ -n "$merge_commits" ]; then
            echo "Includes merge commits from $BASE_BRANCH"
            echo "includes_base=true"       >> "$GITHUB_OUTPUT"
            echo "merge_list=$(echo $merge_commits | tr ' ' ',')" >> "$GITHUB_OUTPUT"
          else
            echo "No merge commits detected from $BASE_BRANCH"
            echo "includes_base=false"      >> "$GITHUB_OUTPUT"
            echo "merge_list="              >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment on detection
        if: steps.detect.outputs.includes_base == 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Posting PR comment..."
          gh api -X POST /repos/$REPO/issues/$PR_NUMBER/comments \
            -f body="‚ö†Ô∏è **Critical Alert**: Merge/Rebase from \`${{ github.base_ref }}\` detected in this feature branch. Please review."

      - name: Send detailed Teams notification on detection
        if: steps.detect.outputs.includes_base == 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPO: ${{ github.repository }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          MERGE_LIST: ${{ steps.detect.outputs.merge_list }}
          BASE_BRANCH_NAME: ${{ github.base_ref }}
          FEATURE_BRANCH: ${{ github.head_ref }}
        run: |
          echo "Preparing Teams notification..."

          IFS=',' read -r -a commits <<< "$MERGE_LIST"

          MERGE_COMMIT_DETAILS=""
          for commit in "${commits[@]}"; do
            commit_info=$(git show -s --format="‚Ä¢ %h by %an on %ad ‚Äî %s" --date=short $commit)
            MERGE_COMMIT_DETAILS="${MERGE_COMMIT_DETAILS}${commit_info}\n"
          done

          teams_message=$(jq -n \
            --arg pr_number "$PR_NUMBER" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_author "$PR_AUTHOR" \
            --arg pr_url "$PR_URL" \
            --arg base_branch "$BASE_BRANCH_NAME" \
            --arg feature_branch "$FEATURE_BRANCH" \
            --arg merge_commits "$MERGE_COMMIT_DETAILS" \
            '{
              type: "AdaptiveCard",
              version: "1.4",
              body: [
                {
                  type: "TextBlock",
                  text: "‚ö†Ô∏è **Critical Alert: Merge/Rebase Detected from Base Branch**",
                  weight: "Bolder",
                  size: "Medium",
                  color: "Attention"
                },
                {
                  type: "FactSet",
                  facts: [
                    { title: "PR Number:", value: "[#"+$pr_number+"]("+$pr_url+")" },
                    { title: "Title:",      value: $pr_title },
                    { title: "Author:",     value: $pr_author },
                    { title: "Base:",       value: $base_branch },
                    { title: "Feature:",    value: $feature_branch }
                  ]
                },
                {
                  type: "TextBlock",
                  text: "Merge Commits Detected:",
                  weight: "Bolder",
                  spacing: "Medium"
                },
                {
                  type: "TextBlock",
                  text: $merge_commits,
                  wrap: true,
                  spacing: "None"
                }
              ],
              msteams: { width: "Full" }
            }')

          curl -H "Content-Type: application/json" -d "$teams_message" "$TEAMS_WEBHOOK_URL"
